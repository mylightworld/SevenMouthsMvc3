@using SevenMouths.Models
@model List<Share>
@{
    ViewBag.Title = "分享列表";
    SevenMouthsEntities context = new SevenMouthsEntities();
    User sharer;
    List<Comment> comments;
    Comment originComment;
    int upCount;
    int downCount;
}

<script type="text/javascript">
    $("tr td").corner("10px");
    $("textarea").corner("10px");
    $(".button").corner("10px");
</script>

<h2>分享列表</h2>
<div>
    <table class="shares">

    <thead>
        <tr>
            <td>编号</td>
            <td>标题</td>
            <td>分类</td>
            <td>分享者</td>
            <td>时间</td>
            <td>顶</td>
            <td>踩</td>
        </tr>
    </thead>
    <tbody>
        @foreach (var share in Model)
        { 
            sharer = context.Users.FirstOrDefault(x => x.UserId == share.SharedBy);
            originComment = context.Comments.FirstOrDefault(x => x.IsOriginal.Value);
            comments = context.Comments.Where(x => x.ShareId.Value == share.ShareId && !x.IsOriginal.Value).ToList();
            upCount = context.Votes.Count(x => x.ShareId == share.ShareId && x.Value > 0);
            downCount = context.Votes.Count(x => x.ShareId == share.ShareId && x.Value < 0);
            <tr>
                <td>@share.ShareNum</td>
                <td><a href ="@share.Url">@share.Title</a></td>
                <td></td>
                
                <td><img src="@sharer.MainPictureUrl" alt="" class="head-portrait"/>@sharer.Name</td>
                <td>@share.SharedAt</td>
                <td><a href="/Shares/VoteToUp/@share.ShareId"><img src="/image/up.jpg" alt="" class="head-portrait"/>顶(@upCount)</a></td>
                <td><a href="/Shares/VoteToDown/@share.ShareId"><img src="/image/down.jpg" alt="" class="head-portrait"/>踩(@downCount)</a></td>
            </tr>
            <tr>
            <td colspan="6">
                <ul>
                <li>
                    <ul>
                        <li style="float:left;"><img src="@sharer.MainPictureUrl" alt="" class="head-portrait"/>@sharer.Name</li>
                        <li style="float:left;">@originComment.Description</li>
                        <li style="float:left;">@originComment.CommentedAt</li>
                    </ul>
                </li>
                @foreach (var comment in comments)
                {
                    User observer = context.Users.FirstOrDefault(x => x.UserId == comment.CommentedBy);
                    <li>
                        <ul>
                            <li style="float:left;"><img src="@observer.MainPictureUrl" alt="" class="head-portrait"/>@observer.Name</li>
                            <li style="float:left;">@comment.Description</li>
                            <li style="float:left;">@comment.CommentedAt</li>
                        </ul>
                    </li>                
                }
                <li><a href="javascript:;" onclick="$(this).parent().siblings('.comments').toggle();">评论(@comments.Count)</a></li>
                <li style="clear:both;display:none;" class="comments">
                    <div>
                    <textarea name="commentContent@(share.ShareId)" id="commentContent@(share.ShareId)" cols="50" rows="4"></textarea>
                    </div>
                    <div><input type="button" class="button" onclick="submitComment('@originComment.ShareId','@originComment.CommentId');" value="评论" /></div>
                </li>
                </ul>
            </td>
            </tr>
        }
     </tbody>

     <tfoot>
        <tr>
            <td>编号</td>
            <td>标题</td>
            <td>分类</td>
            <td>分享者</td>
            <td>时间</td>
            <td>顶</td>
            <td>踩</td>
        </tr>
    </tfoot>
    </table>
</div>
